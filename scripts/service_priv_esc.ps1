# Author: Dustin Mallory
# Name: service_priv_esc
# Version: 1.0
# Description: This powershell script is designed with the intent to help identify weak permissions on misconfigured services
# which an attacker could use to escalate their privileges.
#
# CHANGE LOG
# Author           Date         Description
# Dustin Mallory | 02/02/2019 | Assists in identifying weak permssions on misconfigured services
#
$prevErrorActionPreference = $ErrorActionPreference
$ErrorActionPreference = "silentlycontinue"

# Author: Dustin Mallory
# Name: service_priv_esc
# Version: 1.0
# Description: This powershell script is designed with the intent to help identify weak permissions on misconfigured services
# which an attacker could use to escalate their privileges.
#
# CHANGE LOG
# Author           Date         Description
# Dustin Mallory | 02/02/2019 | Assists in identifying weak permssions on misconfigured services
#
$prevErrorActionPreference = $ErrorActionPreference
$ErrorActionPreference = "silentlycontinue"

Get-WmiObject win32_service | 
ForEach-Object {
    $serviceName = $_.DisplayName
    $serviceDescription = $_.Description
    $servicePath = ( $_.PathName.Replace('"','').Substring(0, $_.PathName.Replace('"','').IndexOf(".exe"))+".exe");
    $acl=Get-Acl $servicePath;
    if(!$acl.Path.EndsWith("svchost.exe")){
    foreach ($item in $acl.Access) {
            if ( ($item.IdentityReference -match "NT AUTHORITY\\SYSTEM"   ) -or
                 ($item.IdentityReference -match "NT SERVICE\\TrustedInstaller") -or
                 ($item.IdentityReference -match "NT AUTHORITY\\NETWORK"  ) -or
                 ($item.IdentityReference -match "BUILTIN\\Administrators") -or
                 ($item.IdentityReference -match "BUILTIN\\Power Users"   ) ) {
            } else {         
                if ($item.FileSystemRights.tostring() -match "Modify|Full|Change") {
                    Write "[!] $ServiceName : Potentially Elevated Service Permission(s)"
                    Write ("      -> "+$item.IdentityReference.value + " : "+$item.AccessControlType.tostring() + " : "+$item.FileSystemRights.tostring())
                    $acl | fl
                }
            }
        }
    }
}
$ErrorActionPreference = $prevErrorActionPreference
