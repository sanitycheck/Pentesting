# Author: Dustin Mallory
# Name: service_priv_esc
# Version: 1.0
# Description: This powershell script is designed with the intent to help identify weak permissions on misconfigured services
# which an attacker could use to escalate their privileges.
#
# CHANGE LOG
# Author           Date         Description
# Dustin Mallory | 02/02/2019 | Assists in identifying weak permssions on misconfigured services
#
$prevErrorActionPreference = $ErrorActionPreference
$ErrorActionPreference = "silentlycontinue"

function getStartmodeDescription {
    Param($startMode)
    return $(switch ($startMode) {
        "Boot" {"Device driver started by the operating system loader."}
        "System" {"Device driver started by the operating system initialization process."}
        "Auto" {"Service to be started automatically by the service control manager during system startup. Auto services are started even if a user does not log on."}
        "Manual" {"Service to be started by the Service Control Manager when a process calls the StartService method. These services do not start unless a user logs on and starts them."}
        "Disabled" {"Service that cannot be started until its StartMode is changed to either Auto or Manual."}
    })
}

$prevErrorActionPreference = $ErrorActionPreference
$ErrorActionPreference = "silentlycontinue"

Get-WmiObject win32_service | 
ForEach-Object {
    $serviceAccount = $_.StartName
    $serviceName = $_.DisplayName
    $serviceDescription = $_.Description
    $startMode = $_.StartMode
    $servicePath = ( $_.PathName.Replace('"','').Substring(0, $_.PathName.Replace('"','').IndexOf(".exe"))+".exe");
    $acl=Get-Acl $servicePath;
    if(!$acl.Path.EndsWith("svchost.exe")){
    foreach ($item in $acl.Access) {
            if ( ($item.IdentityReference -match "NT AUTHORITY\\SYSTEM"   ) -or
                 ($item.IdentityReference -match "NT SERVICE\\TrustedInstaller") -or
                 ($item.IdentityReference -match "NT AUTHORITY\\NETWORK"  ) -or
                 ($item.IdentityReference -match "BUILTIN\\Administrators") -or
                 ($item.IdentityReference -match "BUILTIN\\Power Users"   ) ) {
            } else {         
                if ($item.FileSystemRights.tostring() -match "Modify|Full|Change") {
                    Write "[!] $ServiceName : Potentially Elevated Service Permission(s)"
                    Write ("      -> "+$item.IdentityReference.value + " : "+$item.AccessControlType.tostring() + " : "+$item.FileSystemRights.tostring())
                    Write("")
                    Write('[!] Service is executed with "'+$serviceAccount+'" permissions')
                    Write "[!] Start Mode: $startMode :: $(getStartmodeDescription -startMode $startMode)"
                    $acl | fl
                }
            }
        }
    }
}
$ErrorActionPreference = $prevErrorActionPreference
